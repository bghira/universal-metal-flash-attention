name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      tag_name: ${{ steps.get_tag.outputs.tag_name }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: get_tag
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=v$(date +'%Y%m%d')-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          # Generate changelog since last tag
          if git describe --tags --abbrev=0 HEAD~1 >/dev/null 2>&1; then
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1)
            echo "## Changes since $LAST_TAG" > release_notes.md
            git log --oneline --pretty=format:"- %s (%h)" $LAST_TAG..HEAD >> release_notes.md
          else
            echo "## Initial Release" > release_notes.md
            echo "First release of Universal Metal Flash Attention" >> release_notes.md
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          release_name: Universal Metal Flash Attention ${{ steps.get_tag.outputs.tag_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_tag.outputs.tag_name, 'beta') || contains(steps.get_tag.outputs.tag_name, 'alpha') }}

  build-release-assets:
    name: Build Release Assets
    needs: create-release
    runs-on: macos-14
    strategy:
      matrix:
        configuration: [release]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Swift Package
        run: |
          swift build -c ${{ matrix.configuration }}

          # Create distribution package
          mkdir -p dist/
          cp -r .build/${{ matrix.configuration }}/ dist/swift-${{ matrix.configuration }}/

          # Create source archive
          git archive --format=tar.gz --prefix=universal-metal-flash-attention-${{ needs.create-release.outputs.tag_name }}/ HEAD > dist/source.tar.gz

      - name: Build Python wheels
        run: |
          cd examples/pytorch-custom-op-ffi
          python setup.py bdist_wheel
          cp dist/*.whl ../../dist/

      - name: Create checksums
        run: |
          cd dist
          shasum -a 256 * > checksums.txt

      - name: Upload Release Assets
        run: |
          cd dist
          for file in *; do
            gh release upload ${{ needs.create-release.outputs.tag_name }} "$file"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-docs:
    name: Publish Documentation
    needs: create-release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "5.10"

      - name: Generate documentation
        run: |
          # Generate Swift documentation using DocC if available
          if swift package describe >/dev/null 2>&1; then
            mkdir -p docs/api
            echo "# API Documentation" > docs/api/README.md
            echo "API documentation will be generated here." >> docs/api/README.md
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
